<html>

<head>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="underscore.js"></script>
  <script type="text/javascript" src="backbone.js"></script>
  <script type="text/javascript" src="HeaderView.js"></script>
  <script type="text/javascript" src="ControllerView.js"></script>
  <script type="text/javascript" src="LoginView.js"></script>
  <script type="text/javascript" src="PlaylistView.js"></script>
  <script type="text/javascript" src="BrowseHeader.js"></script>
  <script type="text/javascript" src="ArtistAlbumHeader.js"></script>
  <script type="text/javascript" src="PlaylistItem.js"></script>
  <script type="text/javascript" src="SearchView.js"></script>
  <script type="text/javascript" src="LeftMenu.js"></script>
  <script type="text/javascript" src="ResultView.js"></script>
  <script type="text/javascript" src="Playlist.js"></script>
  <script type="text/javascript" src="CurrentTrackView.js"></script>
  <script type="text/javascript" src="ArtistSimilarItem.js"></script>
  <script type="text/javascript" src="ArtistViewSeparator.js"></script>
  <script type="text/javascript" src="AlbumView.js"></script>
  <script type="text/javascript" src="ArtistView.js"></script>
  <script type="text/javascript" src="ArtistAlbumView.js"></script>
  <script type="text/javascript" src="ArtistTopView.js"></script>
  <script type="text/javascript" src="Track.js"></script>
  <script type="text/javascript" src="Album.js"></script>
  <script type="text/javascript" src="Artist.js"></script>
  <script type="text/javascript" src="PlaylistCollection.js"></script>
  <script type="text/javascript" src="TrackCollection.js"></script>
  <script type="text/javascript" src="AlbumCollection.js"></script>
  <script type="text/javascript" src="ArtistCollection.js"></script>
  <script type="text/javascript" src="TrackView.js"></script>
  <script type="text/javascript" src="TracksView.js"></script>
  <script type="text/javascript" src="QueueView.js"></script>
  <script type="text/javascript" src="ToplistView.js"></script>
  <script type="text/javascript" src="HistoryView.js"></script>
  <script type="text/javascript" src="CreatedHead.js"></script>
  <script type="text/javascript" src="User.js"></script>
  <script type="text/javascript" src="jquery.dataTables.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/jquery.dataTables.css">
  <link rel="stylesheet" type="text/css" href="css/style.css">
   <script>

      $.fn.textWidth = function(){
          var self = $(this),
              children = self.children(),
              calculator = $('<span style="display: inline-block;" />'),
              width;

          children.wrap(calculator);
          width = children.parent().width(); // parent = the calculator wrapper
          children.unwrap();
          return width;
      };

      var init = function(){
        $(document).on("contextmenu",function(ev){
          $("#contextmenu").remove();
          return false;
        });

        document.body.onclick= function(ev){
          if(ev.target.id != "contextmenu" && !ev.target.classList.contains("contextitem")){
            $("#contextmenu").remove();
          }
        }
        var lateststatus;
        var host = window.document.location.host.replace(/:.*/, '');
        var ws = new WebSocket('ws://' + host + ':1650');
        ws.onopen = function(){
          var loginview = new LoginView({el : $("#loginview"), ws : ws});
          var resultview = new ResultView({el : $("#result"), ws : ws});
          var header = new HeaderView({el : $("#header"), ws : ws});
          var current = new CurrentTrackView({el : $("#playtrack"), ws : ws});
          var playlists = new PlaylistCollection();
          var leftmenu = new LeftMenu({model : playlists, el : $("#leftmenu"), ws : ws});
          var control = new ControllerView({el : $("#bottom"), ws : ws});
          ws.onmessage = function (msg) {
              var data = JSON.parse(msg.data);
              console.log(data);
              if(data.loginstatus){
                if(data.loginstatus.login){
                  header.render();
                  control.render();
                  loginview.remove();
                }else{
                  loginview.options.loginstatus = data.loginstatus;
                  loginview.render();
                }
              }else if(data.search){
                var todo = {type:data.search.type};
                if(data.search.type == "search"){
                    todo.data = toTrackCollection(data.search.data);
                    $("#result").trigger("update",todo);
                }else if(data.search.type == "album"){
                    todo.data = toAlbum(data.search.data,true);
                    $("#result").trigger("update",todo);
                }else if(data.search.type == "artist"){
                    todo.data = toArtist(data.search.data,true);
                    $("#result").trigger("update",todo);
                }
              }else if(data.playlists){
                var list = [];
                data.playlists.forEach(function(playlist){
                  list.push(toPlaylist(playlist));
                });
                playlists.reset(list);
              }else if(data.queues){
                data.queues.forEach(function(queue){
                  queue.queue = toTrackCollection(queue.queue);
                });
                $("#result").trigger("update",{type:"queue",data:data.queues});
              }else if(data.history){
                $("#result").trigger("update",{type:"history",data:toTrackCollection(data.history)});
              }else if(data.status){
                if(data.status.track){
                  data.status.track = toTrack(data.status.track);
                }
                lateststatus = data.status;
                $("#bottom").trigger('status',[data.status]);
                $("#playtrack").trigger('status',[data.status]);
                $("#result").trigger('status',[data.status]);
              }
          };
        }
      }


      var toPlaylist = function(playlist){
        var p = new Playlist();
        var isFolder = playlist.playlists;
        p.set("name",playlist.name);
        if(isFolder){
          p.set("playlists",playlist.playlists.map(toPlaylist));
        } else{
          p.set("description",playlist.description);
          p.set("author",toAuthor(playlist.author));
          p.set("tracks",toTrackCollection(playlist.tracks));
          p.set("collaborative",playlist.collaborative);
          p.set("uri",playlist.uri);
        }
        return p;
      }

      var toAuthor = function(author){
        var a = new User();
        a.set("nick",author.nick);
        a.set("name",author.name);
        a.set("uri",author.uri);
        return a;
      }

      var toAlbum = function(album,browse){
        var a = new Album();
        a.set('title', album.title);
        a.set('uri', album.uri);
        a.set('cover', album.cover);
        if(browse){
          a.set("type", album.type);
          a.set('year', album.year);
          a.set('artists', toArtistCollection(album.artists));
          a.set('tracks', toTrackCollection(album.tracks));
        }
        return a;
      }

      var toTrack = function(track){
        var t = new Track();
        t.set('title',track.title);
        t.set('uri',track.uri);
        t.set('artists',toArtistCollection(track.artists));
        t.set('album',toAlbum(track.album));
        t.set('popularity',track.popularity);
        t.set('duration',track.duration);
        t.set('rate',track.rate ? track.rate : 0);
        return t;
      }

      var toArtist = function(artist,browse){
        var a = new Artist();
        a.set('name',artist.name);
        a.set('uri',artist.uri);
        a.set("portrait", artist.portrait);
        if(browse){
          a.set("similar", toArtistCollection(artist.similar));
          a.set("albums",toAlbumCollection(artist.albums,true));
          a.set("bio",artist.bio);
          a.set("toptracks", toTrackCollection(artist.topTracks));
        }
        return a;
      }

      var toArtistCollection = function(artists){
        var col = new ArtistCollection();
        artists.forEach(function(artist){
          col.add(toArtist(artist));
        });
        return col;
      }

      var toAlbumCollection = function(albums,browse){
        var col = new AlbumCollection();
        albums.forEach(function(album){
          col.add(toAlbum(album,browse));
        });
        return col;
      }

      var toTrackCollection = function(tracks){
        var col = new TrackCollection();
        tracks.forEach(function(track){
          col.add(toTrack(track));
        });
        return col;
      }

      var toMinutesAndSeconds = function(time){
        var time = parseInt(time);
        var minutes = parseInt(time/60);
        minutes = minutes < 10 ? "0" + minutes : minutes;
        var seconds = time%60;
        seconds = seconds < 10 ? "0" + seconds : seconds;
        return minutes+":"+seconds;
      }

      var getDurationOfTracks = function(tracks){
        var seconds = 0;
        _.each(tracks.toArray(), function(track){
          seconds += track.get("duration");
        });
        var text = "";
        var min  = parseInt(seconds / 60) % 60;
        var h = parseInt(seconds / 60 / 60);
        if(h> 0 ){
          text = h+" hr ";
        }
        text += min + " min";
        return text;
      }

      var passiveSelectAll = function(select){
        $(".selected").removeClass("selected").addClass("passiveselected");
        if(select){
          select.addClass("selected");
        }
      }

      var imageUrl = function(cover){
        var uri = cover.substring(14);
        return "https://d3rt1990lpmkn.cloudfront.net/300/"+uri;
      }

      var takeInFocus = function (parent, select,totop){
        if(totop){
          parent.scrollTop(0);
        }else{
          var h = parent.innerHeight();
          var s = parent.scrollTop();
          var oh = select.outerHeight();
          var o = select.offset().top - parent.offset().top;
          if(o+oh>h){
            parent.scrollTop(o+oh-h+s);
          }else if(o < 0){
            parent.scrollTop(s+o);
          }
        }
      }

      var findWithAttr = function(array, attr, value) {
        for(var i = 0; i < array.length; i += 1) {
            if(array[i][attr] === value) {
                return i;
            }
        }
        return -1;
      }


    </script>
</head>





<body onload="init();">
<div id="bohnifycontainer">
  <div id="header"></div>
  <div id="leftmenu" class="big"></div>
  <div id="playtrack" class="small"></div>
  <div id="result"></div>
  <div id="bottom"></div>
  <div id="loginview"></div>
</div>
</body>
</html>
